---
type: "always_apply"
description: "Example description"
---
本文档定义了本项目所有AI驱动的代码生成与修改必须遵守的协议，遵循本协议是强制要求。

### **第一部分：元规则与核心指令**

1.  **指令优先原则（附带例外）：** 你的首要任务是执行用户最新指令。**但如果指令直接违反本协议规则（尤其是安全或数据完整性规则），你必须拒绝执行，明确指出违反的规则，并要求提供合规的替代方案。**
2.  **无状态操作：** 你是一个无状态代理。不保留历史交互记忆。所有操作必须仅基于当前提供的上下文和可读取文件的实时状态。  
3.  **协议遵从性：** 在最终回应前，必须内部验证拟议修改是否违反本协议任何条款。

### **第二部分：项目与上下文管理**

1.  **上下文清洁（`.ai-ignore`）：** 为保持上下文窗口清晰，**禁止**读取或索引项目`.ai-ignore`文件中列出的文件。  
2.  **临时文件管理：** 需要临时文件的任务，**必须**在专用`tmp/`目录（该目录会被加入`.ai-ignore`）中创建，并在任务完成前**必须**删除这些文件。

### **第三部分：架构与设计模式**

1.  **关注点分离（验证标准）：** 逻辑必须置于正确层级。使用此标准验证：**"如果将网页前端替换为移动应用，该逻辑是否仍需存在？"**  
    *   **若存在，则属于后端逻辑**  
    *   **若不存在，则属于前端逻辑**  
2.  **Flask蓝图与服务层：** **必须**遵循蓝图/服务层模式。路由作为精简控制器，所有业务逻辑置于服务文件中。  
3.  **配置管理：** 所有配置**必须**从环境变量加载。  
4.  **模块体积限制与主动重构：** 为确保可维护性和代理效率，单个代码文件**严禁**超过**500行代码（LOC）**的硬性限制。  
    *   若请求的修改会导致文件超标，**必须暂停**主请求实施。  
    *   转而**必须**：  
        1.  告知用户目标文件（如`app/services/some_service.py`）即将超过500行限制  
        2.  引用本规则作为暂停依据  
        3.  提出具体重构方案（如"建议先将`some_service.py`中所有验证相关函数提取至新文件`app/services/validation_service.py`"）  
        4.  等待用户明确批准重构方案后再继续  

### **第四部分：代码质量与可读性规范**

1.  **格式化与检查：** 所有Python代码**必须**用`black`格式化，并用`isort`排序导入。  
2.  **代码可读性：** 为避免错误**必须**遵守：  
    *   **类型标注：** 所有函数签名**必须**包含Python类型提示  
    *   **描述性文档字符串：** 所有公开函数和类**必须**使用Google风格文档字符串  
    *   **使用示例：** 新增工具/服务函数的文档字符串**必须**包含简单`示例：`区块  
3.  **代码清洁：** 任务完成前**必须**删除所有注释代码块、未使用导入和失效代码。  

### **第五部分：开发工作流与流程**

1.  **重构与弃用协议：** 替换代码时**必须**遵循流程：**实现新功能→搜索替换→更新引用→验证→删除旧代码→文档记录**。任务完成时任何功能只允许存在单一版本。  
